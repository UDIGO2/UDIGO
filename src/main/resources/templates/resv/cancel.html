<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>예약 취소</title>
    <link rel="stylesheet" th:href="@{/css/myResv.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <style>
        .resv-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .resv-details {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .resv-detail-item {
            flex: 1;
            min-width: 200px;
        }

        .price-info {
            margin-top: 5px;
            color: #333;
        }

        .total-price {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
            margin-top: 10px;
        }

        .label {
            font-weight: bold;
            display: block;
            margin-bottom: 3px;
        }

        .value {
            color: #555;
        }

        .cancel-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .cancel-button:hover {
            background-color: #c82333;
        }

        .button-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .info-text {
            margin-bottom: 20px;
            color: #dc3545;
            font-style: italic;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="content container">
    <h1>내 예약</h1>

    <div class="nav-tabs">
        <a href="/resv/current">현재 예약</a>
        <a href="/resv/past">이전 예약</a>
        <a href="/resv/cancel" class="active">예약 취소</a>
    </div>

    <div class="info-text">
        * 체크인 3일 전까지만 취소가 가능합니다.
    </div>

    <div th:if="${#lists.isEmpty(reservations)}">
        <p>취소 가능한 예약 내역이 없습니다.</p>
    </div>

    <div th:each="reservation : ${reservations}" class="reservation-card">
        <div class="resv-image">
            <img th:src="@{${reservation.acmPhoto1}}" th:alt="${reservation.acmName}">
        </div>
        <div class="resv-info">
            <h2 th:text="${reservation.acmName}">숙소명</h2>

            <div class="resv-details"
                 th:attr="data-checkin=${#temporals.format(reservation.checkIn, 'yyyy-MM-dd')},
                          data-checkout=${#temporals.format(reservation.checkOut, 'yyyy-MM-dd')},
                          data-price=${reservation.acmPrice},
                          data-guests=${reservation.guestCount}">

                <!-- 첫 번째 열: 체크인/체크아웃 -->
                <div class="resv-detail-item">
                    <div>
                        <span class="label">체크인:</span>
                        <span class="value" th:text="${#temporals.format(reservation.checkIn, 'yyyy/MM/dd')}">체크인 날짜</span>
                    </div>
                    <div>
                        <span class="label">체크아웃:</span>
                        <span class="value" th:text="${#temporals.format(reservation.checkOut, 'yyyy/MM/dd')}">체크아웃 날짜</span>
                    </div>
                    <div class="price-info">
                        <span class="label">숙박 일수:</span>
                        <span class="value stay-duration">계산 중...</span>
                    </div>
                </div>

                <!-- 두 번째 열: 인원 및 가격 정보 -->
                <div class="resv-detail-item">
                    <div>
                        <span class="label">투숙 인원:</span>
                        <span class="value" th:text="${reservation.guestCount} + '명'">투숙 인원</span>
                    </div>
                    <div class="price-info">
                        <span class="label">1박 가격:</span>
                        <span class="value" th:text="${#numbers.formatInteger(reservation.acmPrice, 0, 'COMMA')} + '원'"></span>
                    </div>
                    <div class="total-price">
                        <span class="label">총 금액:</span>
                        <span class="total-amount">계산 중...</span>
                    </div>
                </div>
            </div>

            <div class="button-container">
                <a th:href="@{'/acm/detail/' + ${reservation.acmId}}" class="details-button">상세 정보</a>
                <!-- 기존 취소 기능 복원 -->
                <button class="cancel-button"
                        th:onclick="'cancelReservation(' + ${reservation.resvId} + ')'">
                    예약 취소
                </button>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{fragments/footer :: footer}"></div>
<script src="/js/header.js"></script>

<!-- 숙박 일수 및 금액 계산 스크립트 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.resv-details').forEach(function(element) {
            const checkIn = new Date(element.dataset.checkin);
            const checkOut = new Date(element.dataset.checkout);
            const price = parseInt(element.dataset.price);
            const guests = parseInt(element.dataset.guests);

            // 숙박 일수 계산 (밀리초 -> 일)
            const days = Math.round((checkOut - checkIn) / (1000 * 60 * 60 * 24));

            // 총 금액 계산 (1박 가격 × 숙박 일수 × 투숙 인원)
            const totalAmount = price * days * guests;

            // 결과 표시
            element.querySelector('.stay-duration').textContent = days + '박';
            element.querySelector('.total-amount').textContent = totalAmount.toLocaleString() + '원';
        });
    });

    // 기존 예약 취소 함수 복원
    function cancelReservation(resvId) {
        if (confirm('정말로 예약을 취소하시겠습니까?')) {
            fetch(`/resv/cancel/${resvId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('예약이 취소되었습니다.');
                        location.reload();
                    } else {
                        alert(data.message || '예약 취소에 실패했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('예약 취소 중 오류가 발생했습니다.');
                });
        }
    }
</script>
</body>
</html>