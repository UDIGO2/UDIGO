<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>결제하기 | UDIGO</title>
  <link rel="stylesheet" th:href="@{/css/paypage.css}">
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/footer.css}">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      color: #333;
      background-color: #f8f9fa;
      line-height: 1.6;
    }
    
    .pay_main {
      max-width: 800px;
      margin: 40px auto;
      padding: 30px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h2 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #333;
      font-weight: 600;
    }
    
    .section {
      margin-bottom: 30px;
      padding-bottom: 25px;
      border-bottom: 1px solid #eee;
    }
    
    .acm-info {
      display: flex;
      margin-bottom: 20px;
    }
    
    .acm-image {
      width: 120px;
      height: 90px;
      object-fit: cover;
      border-radius: 5px;
      margin-right: 20px;
    }
    
    .acm-details h3 {
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .info-label {
      font-weight: 500;
      color: #666;
    }
    
    .info-value {
      font-weight: 600;
    }
    
    .price-info {
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
      margin-top: 15px;
    }
    
    .total-price {
      color: #ff5a5f;
      font-size: 22px;
      font-weight: 700;
    }
    
    .input-field {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    
    .coupon-section {
      background-color: #f0f7ff;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .payButton {
      width: 100%;
      padding: 15px;
      background-color: #ff5a5f;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .payButton:hover {
      background-color: #e74c3c;
    }
    
    .policy-info {
      font-size: 13px;
      color: #777;
      margin-top: 20px;
    }
  </style>
</head>

<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="pay_main">
  <!-- 예약 정보 -->
  <div class="section">
    <h2>예약 정보</h2>
    <div class="acm-info">
      <img th:src="@{${acmPhoto}}" class="acm-image" alt="숙소 이미지">
      <div class="acm-details">
        <h3 th:text="${acmName}">숙소 이름</h3>
        <div class="info-row">
          <span class="info-label">1박 가격:</span>
          <span class="info-value" th:text="${#numbers.formatInteger(acmPrice, 0, 'COMMA')} + '원'">가격</span>
        </div>
      </div>
    </div>
    
    <div class="info-row">
      <span class="info-label">체크인:</span>
      <span class="info-value" th:text="${checkInDate}">체크인 날짜</span>
    </div>
    <div class="info-row">
      <span class="info-label">체크아웃:</span>
      <span class="info-value" th:text="${checkOutDate}">체크아웃 날짜</span>
    </div>
    <div class="info-row">
      <span class="info-label">숙박 일수:</span>
      <span class="info-value" th:text="${nights} + '박'">1박</span>
    </div>
    <div class="info-row">
      <span class="info-label">인원 수:</span>
      <span class="info-value" th:text="${guestCount} + '명'">인원 수</span>
    </div>
    
    <div class="price-info">
      <div class="info-row">
        <span class="info-label">총 결제 금액:</span>
        <span class="total-price" th:text="${#numbers.formatInteger(totalPrice, 0, 'COMMA')} + '원'">총 가격</span>
      </div>
    </div>
  </div>

  <!-- 예약자 정보 -->
  <div class="section">
    <h2>예약자 정보</h2>
    <div class="info-row">
      <span class="info-label">이름:</span>
      <span class="info-value" th:text="${memberInfo.memberName}">회원 이름</span>
    </div>
    <div class="info-row">
      <span class="info-label">전화번호:</span>
      <input type="text" id="phoneNo" th:value="${memberInfo.phoneNo}" class="input-field" placeholder="전화번호를 입력해주세요">
    </div>
  </div>

  <!-- 쿠폰 적용 -->
  <div class="section coupon-section" th:if="${memberInfo.couponUsed == false}">
    <div class="info-row">
      <span class="info-label">첫 회원가입 쿠폰:</span>
      <span class="info-value">5,000원</span>
    </div>
    <button id="applyCouponButton" class="payButton" style="background-color: #4CAF50; margin-top: 10px;">쿠폰 사용하기</button>
  </div>

  <!-- 결제 정보 -->
  <div class="section">
    <h2>결제 방법</h2>
    <select id="payMethod" class="input-field">
      <option value="카드결제">카드결제</option>
      <option value="간편결제">간편결제</option>
    </select>
  </div>

  <!-- 환불 정책 -->
  <div class="policy-info">
    <p><strong>현장 결제</strong> - 추가 인원 발생 시 추가 금액은 현장에서 납부하셔야 합니다.</p>
    <p><strong>취소 수수료</strong> - 결제 취소는 체크인 7일 이전에만 가능하며, 그 이후에는 환불이 불가합니다.</p>
    <p><strong>필수 이용 수칙</strong> - 각 숙박시설의 규정을 준수해야 합니다. 위반 시 입실 불가, 퇴실 조치 등이 발생할 수 있습니다.</p>
  </div>

  <!-- 결제 버튼 -->
  <button id="confirmPayment" class="payButton">결제하기</button>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
    const acmId = /*[[${acmId}]]*/ '';
    const acmName = /*[[${acmName}]]*/ '';
    const totalPrice = /*[[${totalPrice}]]*/ 0;
    const memberName = /*[[${memberInfo.memberName}]]*/ '';
    const checkInDate = /*[[${checkInDate}]]*/ '';
    const checkOutDate = /*[[${checkOutDate}]]*/ '';
    const guestCount = /*[[${guestCount}]]*/ '';
    let finalPrice = totalPrice;
    let discount = 0;
    
    // 쿠폰 적용 버튼 클릭 이벤트
    const couponButton = document.getElementById('applyCouponButton');
    if (couponButton) {
      couponButton.addEventListener('click', function() {
        discount = 5000;
        finalPrice = totalPrice - discount;
        if (finalPrice < 0) finalPrice = 0;
        
        // 가격 업데이트
        document.querySelector('.total-price').textContent = finalPrice.toLocaleString() + '원';
        
        // 쿠폰 사용 표시
        this.textContent = '쿠폰 적용됨';
        this.disabled = true;
        this.style.backgroundColor = '#aaa';
      });
    }
    
    // 결제하기 버튼 클릭 이벤트
    document.getElementById('confirmPayment').addEventListener('click', function() {
      const phoneNo = document.getElementById('phoneNo').value;
      if (!phoneNo) {
        alert('전화번호를 입력해주세요.');
        return;
      }
      
      const payMethod = document.getElementById('payMethod').value;
      
      // 현재 날짜 및 시간으로 고유 ID 생성
      const now = new Date();
      const transactionId = 'UDIGO_' + now.getFullYear() + 
                           (now.getMonth() + 1).toString().padStart(2, '0') + 
                           now.getDate().toString().padStart(2, '0') + 
                           now.getHours().toString().padStart(2, '0') + 
                           now.getMinutes().toString().padStart(2, '0') + 
                           now.getSeconds().toString().padStart(2, '0');
      
      // 결제 정보 객체 생성
      const paymentData = {
        acmId: acmId,
        acmName: acmName,
        payMethod: payMethod,
        payStatus: '결제완료',
        payType: payMethod === '카드결제' ? '신용카드' : '간편결제',
        payPrice: finalPrice,
        discount: discount,
        payRef: 0,
        transactionId: transactionId,
        payProvider: 'UDIGO',
        checkIn: checkInDate,
        checkOut: checkOutDate,
        guestCount: guestCount,
        isResv: 1
      };
      
      // 서버에 결제 정보 전송
      axios.post('/pay/save', paymentData)
        .then(response => {
          if (response.data.status) {
            const goToReservation = confirm('결제를 성공했습니다\n\n예약 페이지로 이동하시겠습니까?');
            if (goToReservation) {
              window.location.href = '/resv/current';
            } else {
              window.location.href = '/'; // 메인 페이지로 이동
            }
          } else {
            alert('결제 처리 중 오류가 발생했습니다.');
          }
        })
        .catch(error => {
          console.error('결제 처리 오류:', error);
          alert('결제 처리 중 오류가 발생했습니다.');
        });
    });
  });
</script>
</body>
</html>
